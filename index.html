<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BeBetter ¬∑ –¢—Ä–µ–∫–µ—Ä</title>

  <!-- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç Telegram WebApp (–Ω–µ –º–µ—à–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b1220;        /* –≥–ª—É–±–æ–∫–∏–π —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π —Ñ–æ–Ω */
      --card:#111a2b;
      --text:#e8f1ff;
      --muted:#89a3c6;
      --line:#1a2640;
      --accent:#18bfff;    /* —Ü–∏–∞–Ω-–∞–∫—Ü–µ–Ω—Ç */
      --accent-2:#7ad7ff;  /* —Å–≤–µ—Ç–ª—ã–π —Ü–∏–∞–Ω */
      --ring:#274066;

      /* —Ü–≤–µ—Ç–∞ —Å—Ñ–µ—Ä */
      --body:#2dd4bf;      /* –º—è—Ç–Ω–æ-—Ü–∏–∞–Ω–æ–≤—ã–π */
      --mind:#60a5fa;      /* –Ω–µ–±–µ—Å–Ω–æ-—Å–∏–Ω–∏–π */
      --meaning:#a78bfa;   /* —Å–∏—Ä–µ–Ω–µ–≤—ã–π */

      --empty:#24324f;     /* –ø—É—Å—Ç–æ–π —Å–µ–∫—Ç–æ—Ä –¥–Ω—è */
      --danger:#ef4444;    /* –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π */
      --ok:#22c55e;        /* –∑–µ–ª—ë–Ω—ã–π */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 60% -10%, #11213b 0%, #0b1220 55%);
      color:var(--text);
    }
    .wrap{max-width:840px;margin:0 auto;padding:16px 14px 120px}

    /* ====== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å ====== */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px
    }
    .hello{
      display:flex;align-items:center;gap:10px;
      font-weight:600;font-size:16px;
    }
    .hello .avatar{
      width:32px;height:32px;border-radius:999px;background:linear-gradient(135deg,#24324f,#1b2a45);
      display:grid;place-items:center;font-weight:700;color:#9fc4ff
    }
    .streak{
      display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#122242,#0f1a30);
      border:1px solid #1d2c4b;border-radius:14px;padding:8px 12px;
      color:#ffd166;font-weight:700;min-width:72px;justify-content:center
    }
    .streak .ico{filter: drop-shadow(0 0 6px rgba(255,165,0,.35))}
    .sep{height:1px;background:linear-gradient(90deg,transparent, #1f335a, transparent);margin:12px 0}

    /* ====== –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å ====== */
    .days{
      display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;scroll-snap-type:x proximity
    }
    .day{
      flex:0 0 auto;scroll-snap-align:center;
      width:62px;border-radius:16px;padding:10px 8px;background:var(--card);
      border:1px solid var(--line);text-align:center;cursor:pointer;user-select:none;
      transition:transform .12s ease, border-color .12s ease;
    }
    .day:hover{transform:translateY(-2px)}
    .day.selected{border-color:var(--accent);box-shadow:0 0 0 1px rgba(24,191,255,.25) inset}
    .day .dow{font-size:11px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}
    .day .num{font-size:20px;font-weight:800;line-height:1.1;margin:4px 0 6px}
    .ring{
      width:36px;height:36px;border-radius:999px;margin:0 auto;border:2px solid var(--ring);
      background: conic-gradient(var(--empty) 0 120deg, var(--empty) 120deg 240deg, var(--empty) 240deg 360deg);
      position:relative;display:grid;place-items:center;font-size:10px;color:var(--muted);
    }
    .ring::after{ /* –≤–Ω—É—Ç—Ä. –∫—Ä—É–∂–æ–∫ */
      content:""; position:absolute; inset:6px; border-radius:999px; background:#0c1526;
    }

    /* ====== –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã —Å—Ñ–µ—Ä ====== */
    .spheres{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0 10px}
    @media (min-width:720px){ .spheres{grid-template-columns:1fr 1fr 1fr} }
    .sphere{
      background:linear-gradient(180deg,#0e1a30,#0c1628);
      border:1px solid #1b2b4b;border-radius:16px;padding:12px
    }
    .sphere .row{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:8px
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;font-weight:700
    }
    .tag .dot{width:10px;height:10px;border-radius:999px}
    .meter{
      height:12px;border-radius:999px;background:#0b1426;border:1px solid #1c2a49;
      overflow:hidden;position:relative
    }
    .fill{
      height:100%;width:0%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
      transition: width .6s ease
    }
    .pct{font-variant-numeric:tabular-nums;color:#c9defa;font-weight:700}

    /* ====== –ü–æ–¥–ø–∏—Å—å –¥–Ω—è + info ====== */
    .daytitle{
      display:flex;align-items:center;justify-content:space-between;margin:6px 0 6px
    }
    .daytitle .label{font-weight:800;font-size:18px}
    .icon-btn{
      width:34px;height:34px;border-radius:999px;border:1px solid #1e2f51;background:#0e1a30;
      display:grid;place-items:center;cursor:pointer;transition:transform .12s ease, border-color .12s ease
    }
    .icon-btn:hover{transform:translateY(-1px);border-color:var(--accent)}

    /* ====== –í–≤–æ–¥ –ø–æ–±–µ–¥ ====== */
    .inputs{
      display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px
    }
    @media (min-width:720px){ .inputs{grid-template-columns:1fr 1fr 1fr} }
    .input-card{
      background:linear-gradient(180deg,#0e1a30,#0c1628);
      border:1px solid #1b2b4b;border-radius:16px;padding:10px;display:flex;flex-direction:column;gap:8px
    }
    .input-card .hdr{display:flex;align-items:center;gap:8px;font-weight:700}
    .input{
      display:flex;gap:8px;align-items:center
    }
    input[type="text"]{
      flex:1;padding:12px 12px;border-radius:12px;border:1px solid #21365f;background:#0a1324;color:var(--text);
      outline:none;font-size:14px
    }
    .submit{
      width:42px;height:42px;border-radius:12px;border:1px solid #1e2f51;background:#0e1a30;
      display:grid;place-items:center;cursor:pointer;font-size:18px
    }
    .submit:hover{border-color:var(--accent);transform:translateY(-1px)}
    .small{font-size:12px;color:var(--muted)}

    /* ====== –°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è ====== */
    .list{
      margin-top:12px; display:grid; gap:8px
    }
    .item{
      background:linear-gradient(180deg,#0e1a30,#0c1628);
      border:1px solid #1b2b4b;border-radius:14px;padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .item .left{display:flex;align-items:flex-start;gap:8px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #20345a}
    .actions{display:flex;gap:6px}
    .btn{
      height:32px;min-width:32px;border-radius:10px;border:1px solid #1e2f51;background:#0e1a30;
      display:grid;place-items:center;cursor:pointer
    }
    .btn:hover{border-color:var(--accent)}
    .empty{color:var(--muted);text-align:center;margin-top:10px}

    /* ====== –ú–æ–¥–∞–ª–∫–∞ ====== */
    .modal{
      position:fixed;inset:0;background:rgba(5,10,20,.65);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:20
    }
    .modal.show{display:flex}
    .sheet{
      width:min(820px,96vw);max-height:86vh;overflow:auto;
      background:#0b1426;border:1px solid #1d2c4b;border-radius:18px;padding:14px 14px 16px
    }
    .sheet h3{margin:6px 0 12px}
    .grid{display:grid;gap:10px}
    @media (min-width:720px){ .grid{grid-template-columns:1fr 1fr 1fr} }
    .card{
      background:#0c1628;border:1px solid #1b2b4b;border-radius:14px;padding:10px
    }
    .card .title{display:flex;align-items:center;gap:8px;font-weight:800;margin-bottom:6px}
    .modal .close{
      position:sticky;top:0;margin-left:auto;margin-bottom:8px
    }

    /* scrollbars */
    .days::-webkit-scrollbar{height:8px}
    .days::-webkit-scrollbar-thumb{background:#1c2a49;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ===== 1. –í–µ—Ä—Ö: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + —Å—Ç—Ä–∏–∫ ===== -->
    <div class="topbar">
      <div class="hello">
        <div class="avatar">BB</div>
        <div id="hello">–ü—Ä–∏–≤–µ—Ç!</div>
      </div>
      <div class="streak" title="–°–µ—Ä–∏—è –¥–Ω–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é">
        <span class="ico">üî•</span><span id="streak">0</span>
      </div>
    </div>
    <div class="sep"></div>

    <!-- ===== 2. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å ===== -->
    <div id="days" class="days" aria-label="–õ–µ–Ω—Ç–∞ –¥–Ω–µ–π"></div>

    <!-- ===== 3. –°—Ç–∞—Ç—É—Å-–±–∞—Ä—ã —Å—Ñ–µ—Ä ===== -->
    <div class="spheres">
      <div class="sphere" data-s="body">
        <div class="row">
          <div class="tag"><span class="dot" style="background:var(--body)"></span>–¢–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è</div>
          <div class="pct" id="pct-body">0</div>
        </div>
        <div class="meter"><div class="fill" id="bar-body"></div></div>
      </div>
      <div class="sphere" data-s="mind">
        <div class="row">
          <div class="tag"><span class="dot" style="background:var(--mind)"></span>–£–º –∏ —Ñ–æ–∫—É—Å</div>
          <div class="pct" id="pct-mind">0</div>
        </div>
        <div class="meter"><div class="fill" id="bar-mind"></div></div>
      </div>
      <div class="sphere" data-s="meaning">
        <div class="row">
          <div class="tag"><span class="dot" style="background:var(--meaning)"></span>–°–º—ã—Å–ª –∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</div>
          <div class="pct" id="pct-meaning">0</div>
        </div>
        <div class="meter"><div class="fill" id="bar-meaning"></div></div>
      </div>
    </div>

    <!-- ===== 4. –ù–∞–¥–ø–∏—Å—å –¥–Ω—è + info ===== -->
    <div class="daytitle">
      <div class="label" id="dayLabel">–°–µ–≥–æ–¥–Ω—è</div>
      <button class="icon-btn" id="infoBtn" title="–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —Å—Ñ–µ—Ä—ã?">i</button>
    </div>

    <!-- ===== 5. –ë–ª–æ–∫–∏ –≤–≤–æ–¥–∞ –ø–æ–±–µ–¥ ===== -->
    <div class="inputs">
      <div class="input-card" data-s="body">
        <div class="hdr"><span class="dot" style="background:var(--body)"></span>–¢–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è</div>
        <div class="input">
          <input id="inp-body" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 30 –º–∏–Ω —Ö–æ–¥—å–±—ã ¬∑ –∑–∞—Ä—è–¥–∫–∞" />
          <button class="submit" id="btn-body" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–±–µ–¥—É">‚úî</button>
        </div>
        <div class="small">–ö–∞–∂–¥–∞—è –ø–æ–±–µ–¥–∞: +3 –∫ ¬´–¢–µ–ª—É¬ª</div>
      </div>

      <div class="input-card" data-s="mind">
        <div class="hdr"><span class="dot" style="background:var(--mind)"></span>–£–º –∏ —Ñ–æ–∫—É—Å</div>
        <div class="input">
          <input id="inp-mind" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2 —Ñ–æ–∫—É—Å-—Å–µ—Ç–∞ ¬∑ –∑–∞–º–µ—Ç–∫–∞ CBT" />
          <button class="submit" id="btn-mind" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–±–µ–¥—É">‚úî</button>
        </div>
        <div class="small">–ö–∞–∂–¥–∞—è –ø–æ–±–µ–¥–∞: +3 –∫ ¬´–£–º—É¬ª</div>
      </div>

      <div class="input-card" data-s="meaning">
        <div class="hdr"><span class="dot" style="background:var(--meaning)"></span>–°–º—ã—Å–ª –∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</div>
        <div class="input">
          <input id="inp-meaning" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10 –º–∏–Ω –º–µ–¥–∏—Ç–∞—Ü–∏–∏ ¬∑ –∞–∫—Ç —Ü–µ–Ω–Ω–æ—Å—Ç–∏" />
          <button class="submit" id="btn-meaning" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–±–µ–¥—É">‚úî</button>
        </div>
        <div class="small">–ö–∞–∂–¥–∞—è –ø–æ–±–µ–¥–∞: +3 –∫ ¬´–°–º—ã—Å–ª—É¬ª</div>
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–±–µ–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è -->
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–±–µ–¥ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Äî —Å–∞–º–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞—Ç—å üí™</div>
  </div>

  <!-- ===== –ú–æ–¥–∞–ª–∫–∞-–ø–æ—è—Å–Ω–µ–Ω–∏–µ —Å—Ñ–µ—Ä ===== -->
  <div class="modal" id="modal">
    <div class="sheet">
      <button class="icon-btn close" id="closeModal">‚úï</button>
      <h3>–¢—Ä–∏ —Å—Ñ–µ—Ä—ã —Ä–∞–∑–≤–∏—Ç–∏—è</h3>
      <div class="grid">
        <div class="card">
          <div class="title"><span class="dot" style="background:var(--body)"></span>–¢–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è</div>
          <div class="small">
            <b>–û–ø–∏—Å–∞–Ω–∏–µ.</b> –ë–∞–∑–∞ –∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Å–∏–ª—ã: –¥–≤–∏–∂–µ–Ω–∏–µ, —Å–æ–Ω, –ø–∏—Ç–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.<br/>
            <b>–≠—Ñ—Ñ–µ–∫—Ç.</b> –ë–æ–ª—å—à–µ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ; –º–µ–Ω—å—à–µ —Å—Ç—Ä–µ—Å—Å–∞; –ª—É—á—à–µ —Ñ–æ—Ä–º–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ.<br/>
            <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å.</b> 7‚Äì10 —Ç—ã—Å. —à–∞–≥–æ–≤/–¥–µ–Ω—å; 150 –º–∏–Ω –∫–∞—Ä–¥–∏–æ/–Ω–µ–¥ + —Å–∏–ª–æ–≤—ã–µ 2√ó; —Å–æ–Ω 7‚Äì9 —á; –±–µ–ª–æ–∫ –∏ –æ–≤–æ—â–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.
          </div>
        </div>
        <div class="card">
          <div class="title"><span class="dot" style="background:var(--mind)"></span>–£–º –∏ —Ñ–æ–∫—É—Å</div>
          <div class="small">
            <b>–û–ø–∏—Å–∞–Ω–∏–µ.</b> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏–µ–º –∏ –º—ã—Å–ª—è–º–∏ –¥–ª—è —è—Å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.<br/>
            <b>–≠—Ñ—Ñ–µ–∫—Ç.</b> –ú–µ–Ω—å—à–µ —Ç—Ä–µ–≤–æ–≥–∏ –∏ ¬´—à—É–º–∞¬ª; –±–æ–ª—å—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏; –±—ã—Å—Ç—Ä–µ–µ —É—á–∏—à—å—Å—è.<br/>
            <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å.</b> –§–æ–∫—É—Å-—Å–µ—Ç—ã 25‚Äì50 –º–∏–Ω; –¥–Ω–µ–≤–Ω–∏–∫ –º—ã—Å–ª–µ–π (CBT) 1 –∑–∞–ø–∏—Å—å/–¥–µ–Ω—å; 3 –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏; —É—á—ë–±–∞ 30‚Äì60 –º–∏–Ω —Å —Å–∞–º–æ—Ç–µ—Å—Ç–æ–º.
          </div>
        </div>
        <div class="card">
          <div class="title"><span class="dot" style="background:var(--meaning)"></span>–°–º—ã—Å–ª –∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</div>
          <div class="small">
            <b>–û–ø–∏—Å–∞–Ω–∏–µ.</b> –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ–ø–æ—Ä–∞ –Ω–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–∏–Ω—è—Ç–∏–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π –∏ —Å–≤—è–∑—å —Å ¬´–±–æ–ª—å—à–∏–º¬ª.<br/>
            <b>–≠—Ñ—Ñ–µ–∫—Ç.</b> –ì–ª—É–±–æ–∫–∏–π –ø–æ–∫–æ–π; —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ –∫ —Å–µ–±–µ –∏ –¥—Ä—É–≥–∏–º; —è—Å–Ω–æ–µ ¬´–∑–∞—á–µ–º¬ª.<br/>
            <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å.</b> –ú–µ–¥–∏—Ç–∞—Ü–∏—è/—Å–æ–∑–µ—Ä—Ü–∞–Ω–∏–µ 5‚Äì15 –º–∏–Ω; –¥—ã—Ö–∞–Ω–∏–µ 6 —Ü/–º–∏–Ω 5‚Äì10 –º–∏–Ω; 1 ¬´–∞–∫—Ç —Ü–µ–Ω–Ω–æ—Å—Ç–∏¬ª/–Ω–µ–¥; —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω–æ–µ —á—Ç–µ–Ω–∏–µ 10‚Äì20 –º–∏–Ω.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  /* ===== Telegram WebApp ===== */
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

  function applyTheme() {
    if (!tg) return;
    const p = tg.themeParams || {};
    const css = document.documentElement.style;
    if (p.bg_color) css.setProperty('--bg', '#' + p.bg_color);
    if (p.text_color) css.setProperty('--text', '#' + p.text_color);
    if (p.hint_color) css.setProperty('--muted', '#' + p.hint_color);
    if (p.secondary_bg_color) css.setProperty('--card', '#' + p.secondary_bg_color);
    if (p.button_color) css.setProperty('--accent', '#' + p.button_color);
    if (p.button_text_color) css.setProperty('--text-on-btn', '#' + p.button_text_color);
  }

  function setHello() {
    const u = tg?.initDataUnsafe?.user;
    const name = u?.first_name ? u.first_name : '–¥—Ä—É–≥';
    document.getElementById('hello').textContent = `–ü—Ä–∏–≤–µ—Ç, ${name}!`;
    const av = document.querySelector('.avatar');
    av.textContent = (u?.first_name || 'BB').slice(0,2).toUpperCase();
  }

  /* ===== CloudStorage wrappers ===== */
  function cloudSupported(){ return !!(tg && tg.CloudStorage); }
  function cloudGetItem(key){
    return new Promise((res,rej)=> tg.CloudStorage.getItem(key,(err,val)=> err?rej(err):res(val??'') ));
  }
  function cloudSetItem(key,val){
    return new Promise((res,rej)=> tg.CloudStorage.setItem(key,String(val),(err,ok)=> (err||!ok)?rej(err||new Error('setItem failed')):res() ));
  }

  /* ===== Utilities ===== */
  const uuid = () =>
    (crypto?.randomUUID) ? crypto.randomUUID()
      : 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);

  const fmtISO = (d)=> new Date(d).toISOString().slice(0,10);
  const todayISO = ()=> fmtISO(new Date());
  const addDays = (iso,dx)=> fmtISO(new Date(new Date(iso).setDate(new Date(iso).getDate()+dx)));
  const diffDays = (a,b)=> Math.round((new Date(a)-new Date(b))/86400000);

  const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  /* ===== State & storage ===== */
  const KEY = 'victory-tracker-v1';  // –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
  let state = {
    items: [], // {id,text,sphere:'body'|'mind'|'meaning',date:'YYYY-MM-DD',ts:number}
    scores: { body:0, mind:0, meaning:0 }, // 0..100
    lastCalc: null // 'YYYY-MM-DD' ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É—á–ª–∏ —à—Ç—Ä–∞—Ñ—ã
  };

  async function loadState(){
    if (cloudSupported()){
      try {
        const raw = await cloudGetItem(KEY);
        if (raw) return JSON.parse(raw);
      } catch(e){}
    }
    try { return JSON.parse(localStorage.getItem(KEY)) || state; } catch { return state; }
  }
  async function saveState(s){
    if (cloudSupported()){
      try { await cloudSetItem(KEY, JSON.stringify(s)); } catch(e){}
    }
    try { localStorage.setItem(KEY, JSON.stringify(s)); } catch(e){}
  }

  /* ===== Penalties & scoring =====
     +3 –∑–∞ –ø–æ–±–µ–¥—É –ø–æ —Å—Ñ–µ—Ä–µ; -5 –∑–∞ –¥–µ–Ω—å –±–µ–∑ –ø–æ–±–µ–¥ –ø–æ —Å—Ñ–µ—Ä–µ (–Ω–µ –Ω–∏–∂–µ 0).
     –®—Ç—Ä–∞—Ñ—ã —Å—á–∏—Ç–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –æ—Ç lastCalc+1 –¥–æ –≤—á–µ—Ä–∞ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ.
  */
  function dayHasSphere(iso, sphere){
    return state.items.some(it=> it.date===iso && it.sphere===sphere);
  }
  function anyActivity(iso){
    return state.items.some(it=> it.date===iso);
  }

  async function applyPenaltiesUpToToday(){
    const today = todayISO();
    if (!state.lastCalc){
      // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –Ω–µ —à—Ç—Ä–∞—Ñ—É–µ–º –ø—Ä–æ—à–ª–æ–µ
      state.lastCalc = today;
      await saveState(state);
      return;
    }
    // –±–µ–∂–∏–º –ø–æ –¥–Ω—è–º –º–µ–∂–¥—É lastCalc (–∏—Å–∫–ª—é—á–∞—è) –∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –¥–Ω—ë–º (–∏—Å–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è)
    let d = addDays(state.lastCalc, +1);
    const yesterday = addDays(today, -1);
    while (new Date(d) <= new Date(yesterday)){
      ['body','mind','meaning'].forEach(s=>{
        if (!dayHasSphere(d,s)){
          state.scores[s] = Math.max(0, (state.scores[s]||0) - 5);
        }
      });
      d = addDays(d, +1);
    }
    state.lastCalc = today;
    clampScores();
    await saveState(state);
  }

  function addVictory(sphere, text, dateISO){
    const t = (text||'').trim();
    if (!t) return false;
    const iso = dateISO || selectedDate;
    state.items.push({ id: uuid(), text: t, sphere, date: iso, ts: Date.now() });
    state.scores[sphere] = Math.min(100, (state.scores[sphere]||0) + 3);
    clampScores();
    return true;
  }
  function editVictory(id, newText){
    const it = state.items.find(x=> x.id===id);
    if (it && newText.trim()){
      it.text = newText.trim();
      return true;
    }
    return false;
  }
  function deleteVictory(id){
    const before = state.items.length;
    state.items = state.items.filter(x=> x.id!==id);
    return before !== state.items.length;
  }
  function clampScores(){
    ['body','mind','meaning'].forEach(s=>{
      if (state.scores[s] < 0) state.scores[s]=0;
      if (state.scores[s] > 100) state.scores[s]=100;
    });
  }

  /* ===== UI refs ===== */
  const daysEl = document.getElementById('days');
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const dayLabelEl = document.getElementById('dayLabel');
  const streakEl = document.getElementById('streak');

  const bars = {
    body: document.getElementById('bar-body'),
    mind: document.getElementById('bar-mind'),
    meaning: document.getElementById('bar-meaning'),
  };
  const pcts = {
    body: document.getElementById('pct-body'),
    mind: document.getElementById('pct-mind'),
    meaning: document.getElementById('pct-meaning'),
  };

  const inputs = {
    body: document.getElementById('inp-body'),
    mind: document.getElementById('inp-mind'),
    meaning: document.getElementById('inp-meaning'),
  };
  const buttons = {
    body: document.getElementById('btn-body'),
    mind: document.getElementById('btn-mind'),
    meaning: document.getElementById('btn-meaning'),
  };

  /* ===== Selected day ===== */
  let selectedDate = todayISO();

  function labelForDay(iso){
    const t = todayISO();
    const d = diffDays(iso,t);
    if (d===0) return '–°–µ–≥–æ–¥–Ω—è';
    if (d===-1) return '–í—á–µ—Ä–∞';
    if (d===+1) return '–ó–∞–≤—Ç—Ä–∞';
    const dt = new Date(iso);
    const dd = String(dt.getDate()).padStart(2,'0');
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    return `${dd}.${mm}.${dt.getFullYear()}`;
  }

  /* ===== Calendar render ===== */
  function renderDays(){
    daysEl.innerHTML = '';
    // –¥–∏–∞–ø–∞–∑–æ–Ω: -21 .. +7 –¥–Ω–µ–π –æ—Ç —Å–µ–≥–æ–¥–Ω—è
    const start = addDays(todayISO(), -21);
    const end = addDays(todayISO(), +7);
    let cur = start;
    while (new Date(cur) <= new Date(end)){
      const dv = document.createElement('div');
      dv.className = 'day' + (cur===selectedDate ? ' selected' : '');
      dv.dataset.iso = cur;

      const dow = document.createElement('div');
      dow.className = 'dow';
      dow.textContent = DOW[new Date(cur).getDay()];
      const num = document.createElement('div');
      num.className = 'num';
      num.textContent = new Date(cur).getDate();

      const r = document.createElement('div');
      r.className = 'ring';
      // —Å–µ–∫—Ç–æ—Ä –ø–æ —Å—Ñ–µ—Ä–∞–º: —Ü–≤–µ—Ç –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å, –∏–Ω–∞—á–µ --empty
      const s1 = dayHasSphere(cur,'body') ? 'var(--body)' : 'var(--empty)';
      const s2 = dayHasSphere(cur,'mind') ? 'var(--mind)' : 'var(--empty)';
      const s3 = dayHasSphere(cur,'meaning') ? 'var(--meaning)' : 'var(--empty)';
      r.style.background = `conic-gradient(${s1} 0 120deg, ${s2} 120deg 240deg, ${s3} 240deg 360deg)`;

      // –æ—Ç–º–µ—Ç–∫–∞ ¬´—Å–µ–≥–æ–¥–Ω—è¬ª
      if (cur===todayISO()){
        r.style.boxShadow = '0 0 0 2px rgba(24,191,255,.35) inset, 0 0 20px rgba(24,191,255,.15)';
      }

      dv.appendChild(dow);
      dv.appendChild(num);
      dv.appendChild(r);

      dv.addEventListener('click', ()=>{
        selectedDate = dv.dataset.iso;
        renderDays();
        renderDayTitle();
        renderList();
      });

      daysEl.appendChild(dv);
      cur = addDays(cur, +1);
    }
    // —Å–∫—Ä–æ–ª–ª–∏–º –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
    const sel = daysEl.querySelector('.day.selected');
    if (sel) sel.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
  }

  /* ===== Streak ===== */
  function calcStreak(){
    const days = new Set(state.items.map(i=> i.date));
    let d = todayISO();
    if (!days.has(d)) d = addDays(d, -1);
    let cnt = 0;
    while (days.has(d)){
      cnt++; d = addDays(d, -1);
    }
    return cnt;
  }

  /* ===== Bars & title ===== */
  function renderBars(){
    ['body','mind','meaning'].forEach(s=>{
      const v = Math.max(0, Math.min(100, Math.round(state.scores[s]||0)));
      bars[s].style.width = v + '%';
      pcts[s].textContent = v;
    });
  }
  function renderDayTitle(){
    dayLabelEl.textContent = labelForDay(selectedDate);
  }

  /* ===== List of victories for selected day ===== */
  function sphereLabel(s){ return s==='body' ? '–¢–µ–ª–æ' : (s==='mind' ? '–£–º' : '–°–º—ã—Å–ª'); }
  function sphereColor(s){ return s==='body' ? 'var(--body)' : (s==='mind' ? 'var(--mind)' : 'var(--meaning)'); }
  function renderList(){
    const items = state.items
      .filter(i=> i.date===selectedDate)
      .sort((a,b)=> b.ts - a.ts);

    listEl.innerHTML = '';
    if (items.length === 0){
      emptyEl.style.display = 'block';
      return;
    }
    emptyEl.style.display = 'none';

    items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'item';

      const left = document.createElement('div');
      left.className = 'left';
      const pill = document.createElement('div');
      pill.className = 'pill';
      pill.style.color = '#dbeafe';
      pill.style.borderColor = '#20345a';
      pill.style.background = 'rgba(32,52,90,.25)';
      pill.textContent = sphereLabel(it.sphere);

      const text = document.createElement('div');
      text.innerHTML = `<div>${escapeHtml(it.text)}</div><div class="small" style="color:${sphereColor(it.sphere)}">${it.date}</div>`;
      left.appendChild(pill);
      left.appendChild(text);

      const act = document.createElement('div'); act.className='actions';
      const bEdit = document.createElement('button'); bEdit.className='btn'; bEdit.title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; bEdit.textContent='‚úé';
      const bDel  = document.createElement('button'); bDel.className='btn';  bDel.title='–£–¥–∞–ª–∏—Ç—å'; bDel.textContent='üóë';

      bEdit.addEventListener('click', async ()=>{
        const nv = prompt('–ò–∑–º–µ–Ω–∏ —Ç–µ–∫—Å—Ç –ø–æ–±–µ–¥—ã:', it.text);
        if (nv && nv.trim()){
          if (editVictory(it.id, nv)){
            await saveState(state);
            renderList();
          }
        }
      });
      bDel.addEventListener('click', async ()=>{
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–±–µ–¥—É?')){
          if (deleteVictory(it.id)){
            await saveState(state);
            renderDays();
            renderList();
          }
        }
      });

      act.appendChild(bEdit); act.appendChild(bDel);

      row.appendChild(left);
      row.appendChild(act);
      listEl.appendChild(row);
    });
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* ===== Info modal ===== */
  const modal = document.getElementById('modal');
  document.getElementById('infoBtn').addEventListener('click', ()=> modal.classList.add('show'));
  document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', (e)=>{ if (e.target===modal) modal.classList.remove('show'); });

  /* ===== Inputs handlers ===== */
  function bindInput(s){
    buttons[s].addEventListener('click', async ()=>{
      if (addVictory(s, inputs[s].value, selectedDate)){
        inputs[s].value='';
        await saveState(state);
        renderBars(); renderDays(); renderList(); streakEl.textContent = calcStreak();
      }
    });
    inputs[s].addEventListener('keydown', async (e)=>{
      if (e.key==='Enter'){
        e.preventDefault();
        if (addVictory(s, inputs[s].value, selectedDate)){
          inputs[s].value='';
          await saveState(state);
          renderBars(); renderDays(); renderList(); streakEl.textContent = calcStreak();
        }
      }
    });
  }
  ['body','mind','meaning'].forEach(bindInput);

  /* ===== Telegram MainButton ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤—É—é –Ω–µ–ø—É—Å—Ç—É—é –ø–æ–±–µ–¥—É ===== */
  if (tg){
    tg.ready(); tg.expand(); applyTheme(); setHello();
    tg.onEvent('themeChanged', applyTheme);

    tg.MainButton.setParams({ text: '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–±–µ–¥—É' });
    tg.MainButton.onClick(async ()=>{
      const order = ['body','mind','meaning'];
      for (const s of order){
        if (inputs[s].value.trim()){
          if (addVictory(s, inputs[s].value, selectedDate)){
            inputs[s].value='';
            await saveState(state);
            renderBars(); renderDays(); renderList(); streakEl.textContent = calcStreak();
            break;
          }
        }
      }
    });
    tg.MainButton.show();
  }

  /* ===== Init ===== */
  (async ()=>{
    state = await loadState();

    // –±–µ–∑–æ–ø. –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    state.scores = state.scores || { body:0, mind:0, meaning:0 };
    clampScores();

    await applyPenaltiesUpToToday();

    renderBars();
    renderDayTitle();
    renderDays();
    renderList();
    streakEl.textContent = calcStreak();
  })();
});
</script>
</body>
</html>


