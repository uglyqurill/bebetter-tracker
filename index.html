<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BeBetter · Трекер</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Прелоад hero для 1-го экрана онбординга -->
  <link rel="preload" as="image" href="assets/onb-1.avif" imagesrcset="assets/onb-1.avif 1x, assets/onb-1.webp 1x, assets/onb-1.png 1x" />

  <style>
    :root{
      --text:#ffffff;
      --muted:#C7E2FF;

      --bg1:#0F5CC0; --bg2:#0049A8; --bg3:#003C99; --bg4:#003080;
      --card:#0b3a7a;

      --accent:#19E0FF; --accent-2:#7AE7FF;

      --body:#2dd4bf; --mind:#60a5fa; --meaning:#a78bfa;
      --empty:#275aaa;

      /* приятный синий для обводок */
      --edge:#2B6FF6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 35%, var(--bg3) 60%, var(--bg4) 100%);
    }
    .wrap{max-width:900px;margin:0 auto;padding:16px 14px 120px}

    /* ===== Верхняя панель ===== */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .hello{display:flex;align-items:center;gap:10px;font-weight:600;font-size:16px}
    .hello .avatar{
      width:34px;height:34px;border-radius:999px;
      background:linear-gradient(135deg,#1b4f9e,#0f3c81);display:grid;place-items:center;
      font-weight:800;color:#E7F3FF
    }
    .streak{
      display:flex;align-items:center;gap:8px;
      background:linear-gradient(#0f3f87,#0c3270);
      border:1px solid rgba(255,255,255,.22);
      border-radius:14px;padding:8px 12px;
      color:#ffd166;font-weight:800;min-width:72px;justify-content:center
    }
    .sep{height:1px;background:linear-gradient(90deg,transparent, rgba(255,255,255,.25), transparent);margin:12px 0}

    /* ===== Горизонтальный календарь ===== */
    .days{
      display:flex;gap:10px;overflow-x:auto;overflow-y:visible;
      padding:8px 0; scroll-snap-type:x proximity
    }
    .day{
      flex:0 0 auto;scroll-snap-align:center;width:64px;border-radius:16px;padding:10px 8px;
      text-align:center;cursor:pointer;user-select:none;transition:transform .12s ease;
      background:var(--card);border:1px solid rgba(255,255,255,.18)
    }
    .day:hover{transform:translateY(-2px)}
    .day.selected{
      background:
        linear-gradient(180deg, rgba(25,224,255,.15), rgba(122,231,255,.08)) padding-box,
        linear-gradient(60deg, var(--body), var(--mind), var(--meaning)) border-box;
      border:1px solid transparent;
      box-shadow:0 0 16px rgba(122,231,255,.25);
    }
    .day .dow{font-size:11px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}
    .day .num{font-size:20px;font-weight:900;line-height:1.1;margin:4px 0 6px;color:#fff}

    /* ===== Кольцо-секторы (аккуратный контур) ===== */
    .ring{
      --seg1: var(--empty);
      --seg2: var(--empty);
      --seg3: var(--empty);
      position:relative;
      width:38px;height:38px;margin:0 auto;border-radius:50%;
    }
    .ring::before{
      content:"";
      position:absolute; inset:0; border-radius:50%;
      background: conic-gradient(from 90deg, var(--seg1) 0 120deg, var(--seg2) 120deg 240deg, var(--seg3) 240deg 360deg);
      -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 6px), #000 calc(100% - 6px));
              mask: radial-gradient(farthest-side, transparent calc(100% - 6px), #000 calc(100% - 6px));
    }
    .ring::after{
      content:"";
      position:absolute; inset:0; border-radius:50%;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.18);
    }

    /* ===== Прогресс-бары сфер ===== */
    .spheres{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 0 10px}
    @media (min-width:740px){ .spheres{grid-template-columns:1fr 1fr 1fr} }
    .sphere{
      background:linear-gradient(180deg,#0f3f87,#0c3270);
      border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px
    }
    .sphere .row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .tag{display:inline-flex;align-items:center;gap:8px;font-weight:800}
    .tag .dot{width:10px;height:10px;border-radius:999px}
    .meter{
      height:14px;border-radius:999px;background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.2);overflow:hidden;position:relative
    }
    .fill{height:100%;width:0%;transition: width .35s ease-out;}
    .sphere[data-s="body"] .fill{ background:linear-gradient(90deg, var(--body), #5ff4e3); }
    .sphere[data-s="mind"] .fill{ background:linear-gradient(90deg, var(--mind), #a5d8ff); }
    .sphere[data-s="meaning"] .fill{ background:linear-gradient(90deg, var(--meaning), #d8c9ff); }
    .pct{font-variant-numeric:tabular-nums;color:#fff;font-weight:800}

    /* ===== Подпись дня + info ===== */
    .daytitle{display:flex;align-items:center;justify-content:space-between;margin:6px 0 6px}
    .daytitle .label{font-weight:900;font-size:18px;color:#fff}
    .icon-btn{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(#0f3f87,#0c3270);
      border:1px solid var(--edge);
      display:grid;place-items:center;cursor:pointer;transition:transform .12s ease;
      color:#fff; font-weight:900;
    }
    .icon-btn:hover{transform:translateY(-1px)}

    /* ===== Ввод побед ===== */
    .inputs{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    @media (min-width:740px){ .inputs{grid-template-columns:1fr 1fr 1fr} }
    .input-card{
      background:linear-gradient(180deg,#0f3f87,#0c3270);
      border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px
    }
    .input-card .hdr{display:flex;align-items:center;gap:8px;font-weight:800;color:#fff}
    .input{display:flex;gap:8px;align-items:center}
    input[type="text"]{
      flex:1;padding:12px 12px;border-radius:12px;border:1px solid #1A5ED1;background:#08356E;color:#fff;outline:none;font-size:14px
    }
    input::placeholder{color:#9CCAFF}

    /* Кнопка-галочка: светло-серый фон + вспышка цветом сферы */
    .submit{
      width:44px;height:44px;border-radius:12px;
      background:#E6EDF9;                 /* базовый светло-серый */
      border:1px solid var(--edge);
      display:grid;place-items:center;cursor:pointer;
      font-size:18px;color:#fff;font-weight:900;   /* галка белая */
      transition: background-color .2s ease;
    }
    .submit.flash.s-body{   background: var(--body);   }
    .submit.flash.s-mind{   background: var(--mind);   }
    .submit.flash.s-meaning{background: var(--meaning);}

    .small{font-size:12px;color:var(--muted)}

    /* ===== Список побед ===== */
    .list{margin-top:12px; display:grid; gap:8px}
    .item{
      background:linear-gradient(180deg,#0f3f87,#0c3270);
      border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .item .left{display:flex;align-items:flex-start;gap:8px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);color:#fff}
    .actions{display:flex;gap:6px}
    .btn{
      height:32px;min-width:32px;border-radius:10px;
      background:linear-gradient(#0f3f87,#0c3270);
      border:1px solid var(--edge);
      display:grid;place-items:center;cursor:pointer;color:#fff;font-weight:800
    }

    /* ===== Модалка ===== */
    .modal{position:fixed;inset:0;background:rgba(5,10,20,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:20}
    .modal.show{display:flex}
    .sheet{
      width:min(880px,96vw);max-height:86vh;overflow:auto;background:#0f3f87;border:1px solid rgba(255,255,255,.18);border-radius:18px;padding:14px 14px 16px;color:#fff
    }
    .sheet h3{margin:6px 0 12px}
    .grid{display:grid;gap:10px}
    @media (min-width:740px){ .grid{grid-template-columns:1fr 1fr 1fr} }
    .card{background:#0c3270;border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:10px}
    .card .title{display:flex;align-items:center;gap:8px;font-weight:900;margin-bottom:6px}
    .modal .close{position:sticky;top:0;margin-left:auto;margin-bottom:8px}

    .onb-open-wrap{display:flex;justify-content:flex-end;margin-top:10px}
    .btn-mini{height:40px;border-radius:12px;font-weight:900;cursor:pointer;color:#00275f;
      background:linear-gradient(#7AE7FF,#19E0FF); border:1px solid var(--edge); padding:0 14px;
    }

    .days::-webkit-scrollbar{height:8px}
    .days::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:8px}

    /* ===== Онбординг (full-screen overlay) ===== */
    .onb{
      position:fixed; inset:0; z-index:50; display:none;
      background:linear-gradient(180deg,rgba(8,24,64,.85), rgba(8,24,64,.95));
      backdrop-filter: blur(6px);
      color:#fff;
    }
    .onb.show{ display:flex; align-items:center; justify-content:center; padding:18px; }
    .onb-card{
      width:min(860px,96vw); height:min(92vh,860px);
      background:linear-gradient(180deg,#0f3f87,#0c3270);
      border:1px solid rgba(255,255,255,.22); border-radius:22px;
      display:flex; flex-direction:column; overflow:hidden;
    }
    .onb-top{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; }
    .onb-dots{ display:flex; gap:8px; align-items:center; }
    .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.35); }
    .dot.active{ background:#fff; box-shadow:0 0 0 3px rgba(255,255,255,.18) }
    .onb-skip{ background:none; border:0; color:#fff; font-weight:800; cursor:pointer; opacity:.9 }
    .onb-body{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; overflow:auto; padding:12px 18px 0; width:100% }
    .onb-hero{ display:flex; align-items:center; justify-content:center; width:100%; height:34%; min-height:160px; }
    /* фикс позиции и размеров картинки */
    .hero-picture{ display:block; width:min(65%, 420px); margin:0 auto; }
    .hero-img{ display:block; width:100%; height:auto; object-fit:contain; contain:content; }
    @media (max-width:380px){
      .hero-picture{ width:min(70%, 360px); }
      .onb-hero{ height:30%; min-height:140px; }
    }
    .onb-h1{ font-size:24px; font-weight:900; margin:8px 0 6px; text-align:center }
    .onb-p{ font-size:14px; color:#E6F2FF; text-align:center; max-width:720px; margin:0 auto 8px }
    .onb-list{ display:grid; gap:6px; max-width:760px; margin:8px auto 8px; padding:0 8px; font-size:14px }
    .onb-hint{ color:#C7E2FF; opacity:.9; font-size:12px; text-align:center; margin-top:4px }
    .onb-cta{ padding:12px 16px; display:grid; gap:8px }
    .btn-primary{
      height:48px; border-radius:14px; font-weight:900; cursor:pointer; color:#00275f;
      background:linear-gradient(#7AE7FF,#19E0FF); border:1px solid var(--edge);
    }
    .btn-ghost{
      height:44px; border-radius:14px; font-weight:800; cursor:pointer; color:#fff;
      background:transparent; border:1px dashed rgba(255,255,255,.35)
    }
    .swipe{ touch-action:pan-y; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 1. Верх -->
    <div class="topbar">
      <div class="hello">
        <div class="avatar">BB</div>
        <div id="hello">Привет!</div>
      </div>
      <div class="streak" title="Серия дней с активностью">
        <span class="ico">🔥</span><span id="streak">0</span>
      </div>
    </div>
    <div class="sep"></div>

    <!-- 2. Календарь -->
    <div id="days" class="days" aria-label="Лента дней"></div>

    <!-- 3. Прогресс-бары -->
    <div class="spheres">
      <div class="sphere" data-s="body">
        <div class="row">
          <div class="tag"><span class="dot" style="background:var(--body)"></span>Тело и энергия</div>
          <div class="pct" id="pct-body">0/100</div>
        </div>
        <div class="meter"><div class="fill" id="bar-body"></div></div>
      </div>
      <div class="sphere" data-s="mind">
        <div class="row">
          <div class="tag"><span class="dot" style="background:var(--mind)"></span>Ум и фокус</div>
          <div class="pct" id="pct-mind">0/100</div>
        </div>
        <div class="meter"><div class="fill" id="bar-mind"></div></div>
      </div>
      <div class="sphere" data-s="meaning">
        <div class="row">
          <div class="tag"><span class="dot" style="background:var(--meaning)"></span>Смысл и присутствие</div>
          <div class="pct" id="pct-meaning">0/100</div>
        </div>
        <div class="meter"><div class="fill" id="bar-meaning"></div></div>
      </div>
    </div>

    <!-- 4. Подпись дня + info -->
    <div class="daytitle">
      <div class="label" id="dayLabel">Сегодня</div>
      <button class="icon-btn" id="infoBtn" title="Что означают сферы?"><b>i</b></button>
    </div>

    <!-- 5. Ввод побед -->
    <div class="inputs">
      <div class="input-card" data-s="body">
        <div class="hdr"><span class="dot" style="background:var(--body)"></span>Тело и энергия</div>
        <div class="input">
          <input id="inp-body" type="text" placeholder="Напр.: 30 мин ходьбы · зарядка" />
          <button class="submit" id="btn-body" title="Добавить победу">✔</button>
        </div>
        <div class="small">1-я победа дня: +3, последующие сегодня: +1</div>
      </div>

      <div class="input-card" data-s="mind">
        <div class="hdr"><span class="dot" style="background:var(--mind)"></span>Ум и фокус</div>
        <div class="input">
          <input id="inp-mind" type="text" placeholder="Напр.: 2 фокус-сета · заметка CBT" />
          <button class="submit" id="btn-mind" title="Добавить победу">✔</button>
        </div>
        <div class="small">1-я победа дня: +3, последующие сегодня: +1</div>
      </div>

      <div class="input-card" data-s="meaning">
        <div class="hdr"><span class="dot" style="background:var(--meaning)"></span>Смысл и присутствие</div>
        <div class="input">
          <input id="inp-meaning" type="text" placeholder="Напр.: 10 мин медитации · акт ценности" />
          <button class="submit" id="btn-meaning" title="Добавить победу">✔</button>
        </div>
        <div class="small">1-я победа дня: +3, последующие сегодня: +1</div>
      </div>
    </div>

    <!-- Список побед -->
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">Пока нет побед за этот день — самое время начать 💪</div>
  </div>

  <!-- ===== Инфо-модалка ===== -->
  <div class="modal" id="modal">
    <div class="sheet">
      <button class="icon-btn close" id="closeModal">✕</button>
      <h3>Три сферы развития</h3>
      <div class="grid">
        <div class="card">
          <div class="title"><span class="dot" style="background:var(--body)"></span>Тело и энергия</div>
          <div class="small">
            <b>Описание.</b> База жизненной силы: движение, сон, питание и восстановление.<br/>
            <b>Эффект.</b> Больше энергии и стабильное настроение; меньше стресса; лучше форма и здоровье.<br/>
            <b>Что делать.</b> 7–10 тыс. шагов/день; 150 мин кардио/нед + силовые 2×; сон 7–9 ч; белок и овощи каждый день.
          </div>
        </div>
        <div class="card">
          <div class="title"><span class="dot" style="background:var(--mind)"></span>Ум и фокус</div>
          <div class="small">
            <b>Описание.</b> Навыки внимания и мышления: как выбираешь фокус, говоришь с собой, учишься и принимаешь решения.<br/>
            <b>Эффект.</b> Меньше тревоги и «шума»; больше ясности и дисциплины; быстрее учишься и доводишь дела.<br/>
            <b>Что делать.</b> Фокус-сеты 25–50 мин; дневник мыслей (CBT) 1 запись/день; 3 благодарности; учёба 30–60 мин с самотестом.
          </div>
        </div>
        <div class="card">
          <div class="title"><span class="dot" style="background:var(--meaning)"></span>Смысл и присутствие</div>
          <div class="small">
            <b>Описание.</b> Внутренняя опора на ценности, принятие переживаний и связь с «большим».<br/>
            <b>Эффект.</б> Глубокий покой; сострадание к себе и другим; ясное «зачем».<br/>
            <b>Что делать.</b> Медитация/созерцание 5–15 мин; дыхание 6 ц/мин 5–10 мин; 1 «акт ценности»/нед; рефлексивное чтение 10–20 мин.
          </div>
        </div>
      </div>

      <!-- Кнопка перезапуска онбординга (экраны 2–4) -->
      <div class="onb-open-wrap">
        <button class="btn-mini" id="reopenOnb">Краткий онбординг</button>
      </div>
    </div>
  </div>

  <!-- ===== Онбординг ===== -->
  <div class="onb" id="onb">
    <div class="onb-card swipe" id="onbCard">
      <div class="onb-top">
        <div class="onb-dots" id="onbDots" aria-label="Прогресс"></div>
        <button class="onb-skip" id="onbSkip" style="display:none;">Пропустить</button>
      </div>
      <div class="onb-body" id="onbBody"></div>
      <div class="onb-cta" id="onbCta"></div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

  function applyTheme() {
    if (!tg) return;
    const p = tg.themeParams || {};
    const css = document.documentElement.style;
    if (p.button_color) css.setProperty('--accent', '#' + p.button_color);
    if (p.button_color) css.setProperty('--accent-2', '#' + p.button_color);
  }
  function setHello() {
    const u = tg?.initDataUnsafe?.user;
    const name = u?.first_name ? u.first_name : 'друг';
    document.getElementById('hello').textContent = `Привет, ${name}!`;
    const av = document.querySelector('.avatar');
    av.textContent = (u?.first_name || 'BB').slice(0,2).toUpperCase();
  }

  /* CloudStorage */
  function cloudSupported(){ return !!(tg && tg.CloudStorage); }
  function cloudGetItem(key){ return new Promise((res,rej)=> tg.CloudStorage.getItem(key,(e,v)=> e?rej(e):res(v??''))); }
  function cloudSetItem(key,val){ return new Promise((res,rej)=> tg.CloudStorage.setItem(key,String(val),(e,ok)=> (e||!ok)?rej(e||new Error('setItem failed')):res())); }

  /* Utils */
  const uuid = () => (crypto?.randomUUID) ? crypto.randomUUID() : 'id-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8);
  const fmtISO = (d)=> new Date(d).toISOString().slice(0,10);
  const todayISO = ()=> fmtISO(new Date());
  const addDays = (iso,dx)=> {
    const dt = new Date(iso);
    dt.setDate(dt.getDate()+dx);
    return fmtISO(dt);
  };
  const diffDays = (a,b)=> Math.round((new Date(a)-new Date(b))/86400000);
  const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  /* State */
  const KEY = 'victory-tracker-v1';
  let state = { items: [], scores:{body:0,mind:0,meaning:0}, createdAt:null };

  async function loadState(){
    if (cloudSupported()){ try{ const raw = await cloudGetItem(KEY); if (raw) return JSON.parse(raw); }catch{} }
    try{ return JSON.parse(localStorage.getItem(KEY)) || state; }catch{ return state; }
  }
  async function saveState(s){
    if (cloudSupported()){ try{ await cloudSetItem(KEY, JSON.stringify(s)); }catch{} }
    try{ localStorage.setItem(KEY, JSON.stringify(s)); }catch{}
  }

  function recomputeScores(){
    const today = todayISO();
    const allDates = state.items.map(i=>i.date);
    const minItemDate = allDates.length ? allDates.reduce((a,b)=> a<b?a:b) : today;
    const startDate = state.createdAt ? (state.createdAt < minItemDate ? state.createdAt : minItemDate) : minItemDate;

    const counts = {};
    state.items.forEach(it=>{
      counts[it.date] = counts[it.date] || {body:0,mind:0,meaning:0};
      counts[it.date][it.sphere] = (counts[it.date][it.sphere]||0) + 1;
    });

    const scores = { body:0, mind:0, meaning:0 };
    let d = startDate;
    while (new Date(d) <= new Date(today)){
      const dayCounts = counts[d] || {body:0,mind:0,meaning:0};
      ['body','mind','meaning'].forEach(s=>{
        const c = dayCounts[s]||0;
        if (c>0){ scores[s] += 3 + (c-1)*1; } else { if (d !== today) scores[s] -= 5; }
        if (scores[s] < 0) scores[s] = 0;
        if (scores[s] > 100) scores[s] = 100;
      });
      d = addDays(d, +1);
    }
    state.scores = scores;
  }

  /* UI refs */
  const daysEl = document.getElementById('days');
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const dayLabelEl = document.getElementById('dayLabel');
  const streakEl = document.getElementById('streak');

  const bars = {
    body: document.getElementById('bar-body'),
    mind: document.getElementById('bar-mind'),
    meaning: document.getElementById('bar-meaning'),
  };
  const pcts = {
    body: document.getElementById('pct-body'),
    mind: document.getElementById('pct-mind'),
    meaning: document.getElementById('pct-meaning'),
  };
  const inputs = {
    body: document.getElementById('inp-body'),
    mind: document.getElementById('inp-mind'),
    meaning: document.getElementById('inp-meaning'),
  };
  const buttons = {
    body: document.getElementById('btn-body'),
    mind: document.getElementById('btn-mind'),
    meaning: document.getElementById('btn-meaning'),
  };

  /* Calendar */
  let selectedDate = todayISO();

  function labelForDay(iso){
    const t = todayISO();
    const d = diffDays(iso,t);
    if (d===0) return 'Сегодня';
    if (d===-1) return 'Вчера';
    if (d===+1) return 'Завтра';
    const dt = new Date(iso);
    const dd = String(dt.getDate()).padStart(2,'0');
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    return `${dd}.${mm}.${dt.getFullYear()}`;
  }
  function dayHasSphere(iso, sphere){
    return state.items.some(it=> it.date===iso && it.sphere===sphere);
  }
  function renderDays(){
    daysEl.innerHTML = '';
    const start = addDays(todayISO(), -21);
    const end = addDays(todayISO(), +7);
    let cur = start;
    while (new Date(cur) <= new Date(end)){
      const dv = document.createElement('div');
      dv.className = 'day' + (cur===selectedDate ? ' selected' : '');
      dv.dataset.iso = cur;

      const dow = document.createElement('div');
      dow.className = 'dow';
      dow.textContent = DOW[new Date(cur).getDay()];
      const num = document.createElement('div');
      num.className = 'num';
      num.textContent = new Date(cur).getDate();

      const r = document.createElement('div');
      r.className = 'ring';
      r.style.setProperty('--seg1', dayHasSphere(cur,'body') ? 'var(--body)' : 'var(--empty)');
      r.style.setProperty('--seg2', dayHasSphere(cur,'mind') ? 'var(--mind)' : 'var(--empty)');
      r.style.setProperty('--seg3', dayHasSphere(cur,'meaning') ? 'var(--meaning)' : 'var(--empty)');

      dv.appendChild(dow);
      dv.appendChild(num);
      dv.appendChild(r);

      dv.addEventListener('click', ()=>{
        selectedDate = dv.dataset.iso;
        renderDays();
        renderDayTitle();
        renderList();
      });

      daysEl.appendChild(dv);
      cur = addDays(cur, +1);
    }
    const sel = daysEl.querySelector('.day.selected');
    if (sel) sel.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
  }

  function calcStreak(){
    const days = new Set(state.items.map(i=> i.date));
    let d = todayISO();
    if (!days.has(d)) d = addDays(d, -1);
    let cnt = 0;
    while (days.has(d)){ cnt++; d = addDays(d, -1); }
    return cnt;
  }

  function renderBars(){
    ['body','mind','meaning'].forEach(s=>{
      const v = Math.max(0, Math.min(100, Math.round(state.scores[s]||0)));
      bars[s].style.width = v + '%';
      pcts[s].textContent = v + '/100';
    });
  }
  function renderDayTitle(){ dayLabelEl.textContent = labelForDay(selectedDate); }
  function sphereLabel(s){ return s==='body' ? 'Тело' : (s==='mind' ? 'Ум' : 'Смысл'); }
  function sphereColor(s){ return s==='body' ? 'var(--body)' : (s==='mind' ? 'var(--mind)' : 'var(--meaning)'); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  async function doSaveAndRerender(){
    recomputeScores();
    await saveState(state);
    renderBars(); renderDays(); renderList(); streakEl.textContent = calcStreak();
  }

  function renderList(){
    const items = state.items.filter(i=> i.date===selectedDate).sort((a,b)=> b.ts - a.ts);
    listEl.innerHTML = '';
    if (items.length === 0){ emptyEl.style.display = 'block'; return; }
    emptyEl.style.display = 'none';

    items.forEach(it=>{
      const row = document.createElement('div'); row.className = 'item';
      const left = document.createElement('div'); left.className = 'left';

      const pill = document.createElement('div'); pill.className='pill'; pill.textContent = sphereLabel(it.sphere);
      const text = document.createElement('div');
      text.innerHTML = `<div>${escapeHtml(it.text)}</div><div class="small" style="color:${sphereColor(it.sphere)}">${it.date}</div>`;
      left.appendChild(pill); left.appendChild(text);

      const act = document.createElement('div'); act.className='actions';
      const bEdit = document.createElement('button'); bEdit.className='btn'; bEdit.title='Редактировать'; bEdit.textContent='✎';
      const bDel  = document.createElement('button'); bDel.className='btn';  bDel.title='Удалить';      bDel.textContent='🗑';

      bEdit.addEventListener('click', async ()=>{
        const nv = prompt('Измени текст победы:', it.text);
        if (nv && nv.trim()){
          it.text = nv.trim();
          await doSaveAndRerender();
        }
      });
      bDel.addEventListener('click', async ()=>{
        if (confirm('Удалить эту победу?')){
          state.items = state.items.filter(x=>x.id!==it.id);
          await doSaveAndRerender();
        }
      });

      act.appendChild(bEdit); act.appendChild(bDel);
      row.appendChild(left); row.appendChild(act);
      listEl.appendChild(row);
    });
  }

  /* Info modal */
  const modal = document.getElementById('modal');
  document.getElementById('infoBtn').addEventListener('click', ()=> modal.classList.add('show'));
  document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', (e)=>{ if (e.target===modal) modal.classList.remove('show'); });
  document.getElementById('reopenOnb').addEventListener('click', ()=>{
    modal.classList.remove('show');
    showOnboarding(2);
  });

  /* вспышка цвета сферы у кнопки-галочки */
  function flashSubmit(s){
    const btn = buttons[s];
    btn.classList.add('flash', `s-${s}`);
    setTimeout(()=> btn.classList.remove('flash', `s-${s}`), 2000);
  }

  /* Inputs */
  function bindInput(s){
    buttons[s].addEventListener('click', async ()=>{
      const t = inputs[s].value.trim();
      if (!t) return;
      state.items.push({ id: uuid(), text: t, sphere: s, date: selectedDate, ts: Date.now() });
      inputs[s].value='';
      flashSubmit(s);
      await doSaveAndRerender();
    });
    inputs[s].addEventListener('keydown', async (e)=>{
      if (e.key==='Enter'){
        e.preventDefault();
        const t = inputs[s].value.trim();
        if (!t) return;
        state.items.push({ id: uuid(), text: t, sphere: s, date: selectedDate, ts: Date.now() });
        inputs[s].value='';
        flashSubmit(s);
        await doSaveAndRerender();
      }
    });
  }
  ['body','mind','meaning'].forEach(bindInput);

  /* Telegram setup — скрываем нижнюю MainButton */
  if (tg){
    tg.ready(); tg.expand(); applyTheme(); setHello();
    tg.onEvent('themeChanged', applyTheme);
    try { tg.MainButton.hide(); tg.MainButton.offClick?.(); } catch(e){}
  } else {
    document.getElementById('hello').textContent = 'Привет!';
  }

  /* ===== Onboarding ===== */
  const ONB_KEY = 'onboarding_v1_done';
  const onbEl = document.getElementById('onb');
  const onbBody = document.getElementById('onbBody');
  const onbCta  = document.getElementById('onbCta');
  const onbDots = document.getElementById('onbDots');
  const onbSkip = document.getElementById('onbSkip');
  const onbCard = document.getElementById('onbCard');

  // helper: picture HTML (AVIF → WebP → PNG)
  function heroPicture(base, alt, eager=false){
    const loading = eager ? 'eager' : 'lazy';
    return `
      <picture class="hero-picture">
        <source type="image/avif" srcset="${base}.avif">
        <source type="image/webp" srcset="${base}.webp">
        <img class="hero-img" src="${base}.png" alt="${alt}" loading="${loading}" decoding="async" width="800" height="600"/>
      </picture>
    `;
  }

  const slides = [
    {
      id: 1, dots: 0, skip: false,
      base: 'assets/onb-1',
      h1: 'Привет! Это трекер самопрокачки',
      p:  'Помогаем расти в трёх сферах — Тело, Ум и Смысл. Отмечай маленькие победы и смотри, как складывается большой прогресс.',
      renderBody(){
        onbBody.innerHTML = `
          <div class="onb-hero">${heroPicture(this.base,'Онбординг — приветствие',true)}</div>
          <div class="onb-h1">${this.h1}</div>
          <div class="onb-p">${this.p}</div>
        `;
        onbCta.innerHTML = `
          <button class="btn-primary" id="onbNext">Интересно разобраться</button>
          <button class="btn-ghost" id="onbSkipFirst">Разберусь сам</button>
        `;
        document.getElementById('onbNext').onclick = ()=> go(2);
        document.getElementById('onbSkipFirst').onclick = finishOnboarding;
      }
    },
    {
      id: 2, dots: 1, skip: true,
      base: 'assets/onb-2-body',
      h1: 'Тело и энергия',
      items: [
        '<b>Что это.</b> База жизненной силы: движение, сон, питание и восстановление.',
        '<b>Зачем нужно.</b> Стабильная энергия и настроение, меньше стресса и «тумана в голове».',
        '<b>Что будешь фиксировать.</b>',
        '• Шаги/короткое кардио каждый день',
        '• Силовые 2× в неделю',
        '• Сон 7–9 часов и режим',
        '• Маленькие ритуалы восстановления (вода, утренний свет, 5–10 мин растяжки)',
      ],
      hint: 'Регулярность важнее идеала.',
      cta: 'Дальше'
    },
    {
      id: 3, dots: 2, skip: true,
      base: 'assets/onb-3-mind',
      h1: 'Ум и фокус',
      items: [
        '<b>Что это.</b> Навыки внимания и мышления: как выбираешь фокус, говоришь с собой, учишься и принимаешь решения.',
        '<b>Зачем нужно.</b> Меньше «мысленного шума» и тревоги; больше ясности и дисциплины.',
        '<b>Что будешь фиксировать.</b>',
        '• Фокус-сеты 25–50 мин (1–3 в день)',
        '• 1 запись в дневник мыслей (CBT) или 3 благодарности',
        '• Учёбу/чтение 30–60 мин с самотестом',
      ],
      hint: 'Маленькие умные шаги → большой прогресс.',
      cta: 'Дальше'
    },
    {
      id: 4, dots: 3, skip: true,
      base: 'assets/onb-4-meaning',
      h1: 'Смысл и присутствие',
      items: [
        '<b>Что это.</b> Внутренняя опора на ценности: умение быть в моменте, принимать переживания и чувствовать связь с важным.',
        '<b>Зачем нужно.</b> Тихая уверенность вместо суеты, меньше эмоциональных качелей, ясное «ради чего».',
        '<b>Что будешь фиксировать.</b>',
        '• Медитацию/созерцание 5–15 мин',
        '• Дыхание 6 циклов/мин 5–10 мин',
        '• 1 «акт ценности» в неделю',
        '• Рефлексивное чтение 10–20 мин (3–5 строк «что это меняет во мне»)',
      ],
      hint: 'Спокойствие — это тренируемый навык.',
      cta: 'Начать трекер'
    }
  ];

  function renderDots(idx){
    onbDots.innerHTML = '';
    if (slides[idx-1].dots === 0){ onbDots.style.visibility='hidden'; return; }
    onbDots.style.visibility='visible';
    const total = 3;
    for (let i=1;i<=total;i++){
      const d = document.createElement('div');
      d.className = 'dot' + (i===slides[idx-1].dots ? ' active' : '');
      d.addEventListener('click', ()=> go(i+1));
      onbDots.appendChild(d);
    }
  }

  function renderSlide(idx){
    const slide = slides[idx-1];
    renderDots(idx);
    onbSkip.style.display = slide.skip ? 'inline' : 'none';
    if (idx === 1){
      slide.renderBody(); return;
    }
    const listHtml = slide.items.map(x=> `<div>${x}</div>`).join('');
    onbBody.innerHTML = `
      <div class="onb-hero">${heroPicture(slide.base,'Онбординг — иллюстрация')}</div>
      <div class="onb-h1">${slide.h1}</div>
      <div class="onb-list">${listHtml}</div>
      <div class="onb-hint">${slide.hint}</div>
    `;
    onbCta.innerHTML = `<button class="btn-primary" id="onbNext">${slide.cta}</button>`;
    document.getElementById('onbNext').onclick = ()=> { if (idx<slides.length) go(idx+1); else finishOnboarding(); };
  }

  // swipe
  let sx=null;
  onbCard.addEventListener('pointerdown', e=>{ sx = e.clientX; });
  onbCard.addEventListener('pointerup', e=>{
    if (sx===null) return;
    const dx = e.clientX - sx; sx=null;
    const TH = 60;
    if (Math.abs(dx) < TH) return;
    if (dx<0 && curSlide<4) go(curSlide+1);
    if (dx>0 && curSlide>2) go(curSlide-1);
  });

  onbSkip.addEventListener('click', finishOnboarding);

  async function getOnbDone(){
    if (cloudSupported()){
      try{ const v = await cloudGetItem(ONB_KEY); if (v==='true') return true; }catch{}
    }
    try{ return localStorage.getItem(ONB_KEY)==='true'; }catch{ return false; }
  }
  async function setOnbDone(){
    if (cloudSupported()){ try{ await cloudSetItem(ONB_KEY,'true'); }catch{} }
    try{ localStorage.setItem(ONB_KEY,'true'); }catch{}
  }

  function showOnboarding(startAt=1){
    onbEl.classList.add('show');
    go(startAt);
  }
  async function finishOnboarding(){
    await setOnbDone();
    onbEl.classList.remove('show');
  }

  let curSlide = 1;
  function go(n){
    if (n < 2 && curSlide >= 2) n = 2; // не даём вернуться на 1-й при «кратком»
    curSlide = n;
    renderSlide(n);
  }

  // прелоад прочих изображений
  ['assets/onb-2-body.avif','assets/onb-3-mind.avif','assets/onb-4-meaning.avif']
    .forEach(src=>{ const im = new Image(); im.src = src; });

  /* Init */
  (async ()=>{
    state = await loadState();
    if (!state.createdAt){ state.createdAt = todayISO(); }
    if (!state.scores){ state.scores = {body:0,mind:0,meaning:0}; }

    recomputeScores();
    await saveState(state);

    renderBars(); renderDayTitle(); renderDays(); renderList();
    streakEl.textContent = calcStreak();

    // скрываем MainButton Телеги
    try{ tg?.MainButton?.hide(); tg?.MainButton?.offClick?.(); }catch{}

    // Покажем онбординг только при самом первом запуске
    const done = await getOnbDone();
    if (!done){ showOnboarding(1); }
  })();
});
</script>
</body>
</html>
