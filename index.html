<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–æ–π —Ç—Ä–µ–∫–µ—Ä –ø–æ–±–µ–¥</title>

  <!-- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç Telegram WebApp (–Ω–µ –º–µ—à–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#ffffff; --text:#111111; --muted:#666; --card:#f4f4f4; --accent:#0088cc;
    }
    * { box-sizing: border-box; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:720px;margin:0 auto;padding:16px 16px 80px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
    header h1{font-size:20px;margin:0;}
    .stats{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 16px;}
    .chip{background:var(--card);padding:10px 12px;border-radius:12px;font-size:14px}
    .row{display:flex;gap:8px;margin-bottom:12px}
    input[type="text"]{flex:1;padding:12px;border:1px solid #ddd;border-radius:12px;font-size:16px;background:#fff}
    button{padding:12px 14px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:600;font-size:16px;cursor:pointer}
    ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
    li{background:var(--card);padding:10px 12px;border-radius:12px;display:flex;align-items:center;justify-content:space-between}
    .muted{color:var(--muted);font-size:12px}
    .empty{color:var(--muted);text-align:center;margin-top:24px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>–¢—Ä–µ–∫–µ—Ä –ø–æ–±–µ–¥ <span id="hello"></span></h1>
    </header>

    <div class="stats">
      <div class="chip">–í—Å–µ–≥–æ: <b id="total">0</b></div>
      <div class="chip">–°–µ—Ä–∏—è –¥–Ω–µ–π: <b id="streak">0</b></div>
      <div class="chip">–°–µ–≥–æ–¥–Ω—è: <b id="today">0</b></div>
    </div>

    <div class="row">
      <input id="inp" type="text" placeholder="–ö–∞–∫–∞—è –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–±–µ–¥–∞ —Å–µ–≥–æ–¥–Ω—è?" />
      <button id="addBtn" type="button">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <ul id="list"></ul>
    <div id="empty" class="empty" style="display:none;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞—á–Ω–∏ —Å –º–∞–ª–µ–Ω—å–∫–æ–π –ø–æ–±–µ–¥—ã üí™</div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // --- Telegram WebApp (–º–æ–∂–µ—Ç –±—ã—Ç—å null –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ) ---
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

  // --- –¢–µ–º–∞ –∏–∑ Telegram ---
  function applyTheme() {
    if (!tg) return;
    const p = tg.themeParams || {};
    const css = document.documentElement.style;
    if (p.bg_color) css.setProperty('--bg', '#' + p.bg_color);
    if (p.text_color) css.setProperty('--text', '#' + p.text_color);
    if (p.hint_color) css.setProperty('--muted', '#' + p.hint_color);
    if (p.secondary_bg_color) css.setProperty('--card', '#' + p.secondary_bg_color);
    if (p.button_color) css.setProperty('--accent', '#' + p.button_color);
  }

  const hello = document.getElementById('hello');
  function setHello() {
    const u = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
    const name = u && u.first_name ? u.first_name : '';
    hello.textContent = name ? `¬∑ –ø—Ä–∏–≤–µ—Ç, ${name}` : '';
  }

  // --- –û–±–ª–∞–∫–æ Telegram CloudStorage (–æ–±—ë—Ä—Ç–∫–∏ —Å –ø—Ä–æ–º–∏—Å–∞–º–∏) ---
  function cloudSupported() {
    return !!(tg && tg.CloudStorage);
  }
  function cloudGetItem(key) {
    return new Promise((resolve, reject) => {
      tg.CloudStorage.getItem(key, (err, val) => {
        if (err) reject(err); else resolve(val ?? '');
      });
    });
  }
  function cloudSetItem(key, val) {
    return new Promise((resolve, reject) => {
      tg.CloudStorage.setItem(key, String(val), (err, ok) => {
        if (err || !ok) reject(err || new Error('setItem failed')); else resolve();
      });
    });
  }

  // --- –£—Ç–∏–ª–∏—Ç—ã ---
  const uuid = () =>
    (window.crypto && typeof window.crypto.randomUUID === 'function')
      ? window.crypto.randomUUID()
      : 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);

  const todayISO = () => new Date().toISOString().slice(0,10);

  function calcStreak(items){
    const set = new Set(items.map(i=>i.date));
    if (set.size === 0) return 0;
    const d = new Date();
    let cur = todayISO();
    let count = 0;
    if (!set.has(cur)) { d.setDate(d.getDate() - 1); cur = d.toISOString().slice(0,10); }
    while (set.has(cur)) { count++; d.setDate(d.getDate() - 1); cur = d.toISOString().slice(0,10); }
    return count;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  // --- –•—Ä–∞–Ω–∏–ª–∏—â–µ: CloudStorage (–µ—Å–ª–∏ –µ—Å—Ç—å) + localStorage ---
  const KEY = 'victory-tracker-v1';

  async function loadState() {
    // 1) –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞ –¢–µ–ª–µ–≥—Ä–∞–º–∞
    if (cloudSupported()) {
      try {
        const raw = await cloudGetItem(KEY);
        if (raw) return JSON.parse(raw);
      } catch (_) {}
    }
    // 2) –§–æ–ª–ª–±–µ–∫: localStorage
    try { return JSON.parse(localStorage.getItem(KEY)) || { items: [] }; }
    catch { return { items: [] }; }
  }

  async function saveState(state) {
    // –ü–∏—à–µ–º –∏ –≤ –æ–±–ª–∞–∫–æ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ), –∏ –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ –±—ç–∫–∞–ø
    if (cloudSupported()) {
      try { await cloudSetItem(KEY, JSON.stringify(state)); } catch (_) {}
    }
    try { localStorage.setItem(KEY, JSON.stringify(state)); } catch (_) {}
  }

  // --- –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
  const list = document.getElementById('list');
  const empty = document.getElementById('empty');
  const $total = document.getElementById('total');
  const $streak = document.getElementById('streak');
  const $today = document.getElementById('today');
  const inp = document.getElementById('inp');
  const addBtn = document.getElementById('addBtn');

  // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
  let state = { items: [] };

  function render(){
    list.innerHTML = '';
    if (state.items.length === 0) {
      empty.style.display = 'block';
    } else {
      empty.style.display = 'none';
      state.items
        .slice()
        .sort((a,b)=> b.ts - a.ts)
        .forEach(item=>{
          const li = document.createElement('li');

          const left = document.createElement('div');
          left.innerHTML = `<div>${escapeHtml(item.text)}</div><div class="muted">${item.date}</div>`;

          const del = document.createElement('button');
          del.type = 'button';
          del.textContent = '√ó';
          del.style.minWidth = '36px';
          del.style.padding = '6px 10px';
          del.title = '–£–¥–∞–ª–∏—Ç—å';
          del.addEventListener('click', async () => {
            state.items = state.items.filter(x=>x.id!==item.id);
            await saveState(state);
            render();
          });

          const right = document.createElement('div');
          right.appendChild(del);

          li.appendChild(left);
          li.appendChild(right);
          list.appendChild(li);
        });
    }
    $total.textContent = state.items.length;
    $streak.textContent = calcStreak(state.items);
    $today.textContent = state.items.filter(i=>i.date===todayISO()).length;
  }

  async function addVictory(textFromBtn){
    const t = (textFromBtn ?? inp.value).trim();
    if (!t) return;
    state.items.push({
      id: uuid(),
      text: t,
      date: todayISO(),
      ts: Date.now()
    });
    await saveState(state);
    render();
    inp.value = '';
  }

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
  (async () => {
    // Telegram –≥–æ—Ç–æ–≤
    if (tg) {
      tg.ready();
      tg.expand();
      applyTheme();
      setHello();
      tg.onEvent('themeChanged', applyTheme);

      // –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram
      tg.MainButton.setParams({ text: '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–±–µ–¥—É' });
      tg.MainButton.onClick(() => addVictory());
      tg.MainButton.show();
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
    state = await loadState();
    render();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    addBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await addVictory();
    });

    inp.addEventListener('keydown', async (e)=>{
      if (e.key === 'Enter') {
        e.preventDefault();
        await addVictory();
      }
    });
  })();
});
</script>
</body>
</html>

